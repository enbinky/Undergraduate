import matplotlib.pyplot as plt
import pandas as pd
from collections import Counter
import matplotlib

# 模拟大段文本数据（请替换为完整 raw_text 内容）
raw_text = """
污染物来源行业及生产地
医药/避孕药物研发；美国密歇根州米德兰市（DowCorning公司提供）。
No Answer
个人护理产品行业（未明确具体生产地）
-化妆品和个人护理产品（PCPs）行业，韩国（未明确具体行政区）
-来源行业食品废弃物、畜禽粪便、污水污泥、垃圾填埋气（韩国多个地区）-生产地韩国（未提具体行政区）
家用烤箱（可能含硅胶密封材料或润滑剂），美国（未提具体州）
No Answer
No Answer
-行业增材制造（3D打印）材料-生产地美国（DowCorning公司生产的SE1700和OE6636树脂）
No Answer
个人护理产品（如除臭剂、乳液）和工业产品（如密封剂、润滑剂）；未提及具体生产地。
个人护理产品（化妆品行业），未提及具体生产地
No Answer
化妆品、医药、材料工业（如硅油、弹性体等），未提及具体生产地。
No Answer
-个人护理产品（洗发水、护肤品等）、污水处理厂污泥、垃圾填埋场（未具体到国家行政区）
No Answer
个人护理产品（如除臭剂），发达国家城市地区（未具体到国家下一级行政区）
个人护理产品和工业应用（全球范围，未具体到行政区）
个人护理产品（如化妆品、护肤品、洗发水等）、石化工业（如废水处理厂），主要来自西班牙加泰罗尼亚地区
护发产品行业，未明确提及具体生产地
个人护理产品、硅聚合物生产（未明确具体生产地）
个人护理产品行业（如化妆品、除臭剂等），美国加利福尼亚州
个人护理产品、化妆品、工业应用（如电子产品、硅聚合物、医疗器械）；未提及具体生产地
个人护理产品（如护肤品、除臭剂）、工业用途（硅聚合物制造、润滑剂等）；未明确具体生产地，但采样覆盖多国。
个人护理产品、聚合物工业（未明确具体生产地）
个人护理产品行业、污水处理厂（STPs）和垃圾填埋场；加拿大安大略省多伦多市
-来源行业个人护理产品（洗发水、化妆品）、家用产品（洗涤剂）、工业产品（涂料）。-生产地未明确提及具体地区，但文献提到硅氧烷在填埋场和污水处理厂的沼气中常见。
半导体行业（HMDS作为光刻胶粘附促进剂），未提具体地区
未明确提及具体行业或生产地（但提及硅氧烷广泛用于个人护理产品等）
个人护理产品（PCPs），未明确具体生产地。
No Answer
化妆品、个人护理品、涂料等行业（未具体说明生产地）
化妆品、电子产品、涂料、食品添加剂等行业（未提具体生产地）。
-化妆品、个人护理产品（PCPs）、电子工业、石油工业等；-主要生产地中国、美国、欧盟（如加州、广东、北京等）。
No Answer
No Answer
化妆品、个人护理产品（如洗发水）、工业应用（如消泡剂、涂料）；未提及具体生产地
个人护理产品行业，美国（未明确具体州）
-医疗级硅油（眼科手术材料），生产商包括Fluoron（德国乌尔姆）、Alchimia（意大利蓬泰圣尼科洛）
化妆品和个人护理产品、洗涤剂、建筑材料、纺织品（未具体说明生产地）
化妆品/消毒剂行业，波兰雅沃日诺（ICBPharma生产）
No Answer
-来源行业污水处理厂、垃圾填埋场（通过厌氧消化产生沼气）-生产地未明确具体地区，但研究背景为巴西
个人护理品、工业产品（如化妆品、清洁剂等）；中国吉林省（文中提及中国产能数据）
烘焙模具行业，生产地包括德国、意大利、中国（部分未标注）
未明确提及（实验用D4为标气，来源未说明）
-来源行业化工材料（环氧树脂改性）-生产地中国（D4H购自宁波润禾高新材料有限公司）
化妆品/工业化学品，美国密歇根州（DowCorning公司提供）
-来源行业沼气（污水处理厂、垃圾填埋场等有机废弃物厌氧发酵）-生产地未明确提及具体地区，但实验在墨西哥进行（作者单位墨西哥国立自治大学）
化妆品行业、干洗行业（未提及具体生产地）
No Answer
填埋场沼气（未提具体生产地，但实验在比利时进行，材料来自VWR和Sigma-Aldrich比利时分公司）。
No Answer
No Answer
-行业电子产品、纺织品、个人护理品、硅聚合物生产-生产地欧洲（未具体到行政区）
-来源行业污水处理厂（WWTPs）沼气中的硅氧烷污染物-生产地未具体提及，但文献引用数据包括德国、意大利等地的污水处理厂
No Answer
污水处理厂（WWTP）沼气，未提具体生产地
污水处理厂（WWTP）和垃圾填埋场；未明确具体生产地
化妆品、洗涤剂等行业（文献未提具体生产地）
-来源行业化妆品/聚合物改性行业-生产地中国广东省深圳市（D4供应商ShenzhenJi-PengSiliconFluorideMaterialsCorporation）
污水沼气（污水处理厂），西班牙巴塞罗那（Rubí污水处理厂）
-来源行业沼气（填埋场/污水处理厂）-生产地L2和D4购自日本东京化学工业株式会社
No Answer
填埋场沼气（未提具体生产地）
化妆品、密封剂、生物植入物等行业（未提具体生产地）
No Answer
-来源行业化妆品、聚合物添加剂（硅氧烷作为阻燃剂）-生产地中国上海（试剂供应商为阿拉丁，上海）
No Answer
No Answer
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省-
No Answer
化妆品、汽车蜡、燃料添加剂等行业；未明确具体生产地
-来源行业化妆品或其他消费品行业（文献提到D4和D5广泛用于消费品）-生产地美国密歇根州米德兰市（DowCorningCorporation）
个人护理品行业，中国浙江省
个人护理产品（PCPs）行业，全球范围（如美国、欧洲）
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
化妆品和个人护理产品行业，未提及具体生产地。
污水处理厂，日本京都
个人护理品行业，中国浙江省
个人护理和清洁产品行业（未提及具体生产地）
个人护理品行业，中国浙江省
个人护理品行业，中国江苏省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
-个人护理产品（化妆品、消费品）、干洗行业（D5）。-未明确提及生产地，但研究由全球硅胶工业协会（GSC/SEHSC）支持，推测涉及多国生产。
个人护理品行业，中国江苏省
个人护理品行业，中国浙江省
个人护理品行业，中国江苏省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省-
个人护理品行业，中国浙江省-
个人护理品行业，中国浙江省-
-来源行业沼气（可能来自废弃物处理或农业）-生产地比利时（活性炭供应商CHEMVIRON）
个人护理品行业，中国浙江省
化妆品、医药、食品行业；全球主要生产地包括美国、中国、德国、日本等
污水处理厂厌氧消化过程产生的沼气（未提具体行政区，研究合作方为英国SevernTrentPLC）
化妆品、个人护理产品、工业应用（未具体提及生产地）。
-来源行业垃圾填埋场和厌氧消化池（主要来自废弃物处理设施）-生产地未明确提及具体生产地，但实验使用的硅氧烷购自美国密苏里州圣路易斯的SigmaAldrich
化妆品行业（如ZeradermRofilMedical,LaRoche-PosayHydreaneRichecream等），未提及具体生产地
个人护理产品和化妆品行业，欧盟（具体国家未提及）
个人护理产品（如化妆品）、粘合剂；未明确具体生产地，但采样涉及北美和欧洲
个人护理和家用产品行业，美国（未提及具体行政区）
个人护理产品（PCPs），未具体说明生产地
化妆品、个人护理产品行业（未提具体生产地）
个人护理产品（PCPs），未提及具体生产地
个人护理产品行业（如洗面奶、面霜、洗发水等），中国北京市
个人护理产品行业（未提具体生产地）
个人护理产品行业（化妆品等），主要来自北美和欧洲
化妆品行业（全球范围，未具体到行政区）
化妆品行业（基于人均排放估算），未提具体生产地
个人护理产品（PCPs，如洗发水、化妆品等），来源未明确具体国家/地区，但韩国环境部批准使用。
化妆品行业，中国北京市
-来源行业化妆品、洗涤剂、密封剂、食品添加剂等消费品行业-生产地未具体提及（全球性生产，文献未限定地区）
化妆品和个人护理产品行业（全球范围，未具体到行政区）。
个人护理品（如止汗剂、护发产品）、清洁剂、硅胶制品；主要排放区域为北美（美国、加拿大、墨西哥）城市
个人护理产品（如化妆品、香水等），未明确提及具体生产地
个人护理产品（PCPs）、化妆品、工业废水（韩国工业区）
化妆品、钢铁、制药等行业，韩国京畿道始华湖周边工业区
个人护理产品、化妆品行业（未提具体生产地）
No Answer
甲基硅氧烷生产工厂，中国辽宁省
化妆品、涂料、机械流体、橡胶等行业（未提及具体生产地）
-硅氧烷（D4、D5、L2）广泛用于个人护理产品、工业应用（如涂料、密封剂等），来源行业未具体说明-硫化氢（H₂S）填埋场中硫酸盐还原菌的代谢产物
No Answer
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国浙江省
个人护理品行业，中国江苏省
No Answer
No Answer
污水处理行业（具体国家未提及，案例研究位于英国）
个人护理产品（如止汗剂、护发和护肤品），未提及具体生产地
个人护理产品（如止汗剂、护发素），未提具体生产地
化妆品和个人护理产品（C&PCPs）行业，未明确提及具体生产地。
化妆品、密封剂、润滑剂、干洗等工业过程（未明确具体生产地）
No Answer
化妆品行业/高温传热流体；样本由DowCorning提供（未提具体生产地）
ORC发电系统（生物质燃料），欧洲多国（如德国斯图加特）。
"""  # 请粘贴完整数据

# 字体设置
matplotlib.rcParams['font.sans-serif'] = ['KaiTi']  # 中文楷体
matplotlib.rcParams['axes.unicode_minus'] = False

# 清洗
lines = [line.strip().strip('。') for line in raw_text.strip().split('\n') if line.strip()]

# 行业关键词列表
industry_keywords = [
    '个人护理', '化妆品', '医药', '电子', '污水', '垃圾填埋', '食品', '家用', '工业', '材料', '半导体', '汽车', '涂料',
    '建筑', '纺织', '干洗', '生物质', '增材制造', '聚合物', '粘合剂', '消毒剂', '密封剂', '润滑剂', '高温传热流体'
]

# 分类函数
def classify_industry(entry):
    for keyword in industry_keywords:
        if keyword in entry:
            return keyword
    if 'No Answer' in entry or not entry.strip():
        return '未提供'
    return '其他'

# 分类与统计
classified = [classify_industry(line) for line in lines]
industry_counter = Counter(classified)

# 将 "未提供" 放最后，其余按频次排序
main_items = [(k, v) for k, v in industry_counter.items() if k != '未提供']
main_items = sorted(main_items, key=lambda x: x[1], reverse=True)
if '未提供' in industry_counter:
    main_items.append(('未提供', industry_counter['未提供']))

labels, counts = zip(*main_items)

# 颜色设置：深绿到浅绿 + 白色
cmap = plt.cm.Greens
green_colors = [cmap(i / (len(labels) - 1)) for i in range(len(labels) - 1)][::-1]  # 深→浅
colors = green_colors + ['white']  # 最后一列为白色

# 画图
fig, ax = plt.subplots(figsize=(14, 6))
bars = ax.bar(labels, counts, color=colors, edgecolor='black')

# 轴标题
ax.set_title("污染物来源行业统计", fontsize=20)
ax.set_ylabel("频次", fontsize=14)
ax.set_xlabel("来源行业", fontsize=14)
ax.set_xticks(range(len(labels)))
ax.set_xticklabels(labels, rotation=45, fontsize=12)
ax.set_yticklabels(ax.get_yticks(), fontsize=12)

# 数值标签
for bar in bars:
    height = bar.get_height()
    ax.text(bar.get_x() + bar.get_width() / 2, height + 0.5, str(height),
            ha='center', va='bottom', fontsize=10)

# 保存表格
df_industry = pd.DataFrame(main_items, columns=["来源行业", "频次"])
df_industry.to_excel("污染物来源行业统计表.xlsx", index=False)
print(df_industry)

# 保存图像
fig.tight_layout()
fig.savefig("污染物来源行业柱状图.png", dpi=300, bbox_inches='tight')
plt.show()